@inject ISnackbar Snackbar
@using MailKit.Net.Imap
@using MailKit.Net.Pop3
@using MailKit

<MudButton Variant="Variant.Outlined"
           Color="Color.Info"
           StartIcon="@Icons.Material.Filled.MailLock"
           OnClick="TestConnection"
           Disabled="testing">
    @if (testing)
    {
        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
        <span>Testing...</span>
    }
    else
    {
        <span>Test @(Provider?.ToUpper()) Connection</span>
    }
</MudButton>

@code {
    [Parameter] public string? Provider { get; set; }
    [Parameter] public string? Server { get; set; }
    [Parameter] public int? Port { get; set; }
    [Parameter] public string? Username { get; set; }
    [Parameter] public string? Password { get; set; }
    [Parameter] public bool? UseSsl { get; set; }

    private bool testing;

    private async Task TestConnection()
    {
        if (string.IsNullOrEmpty(Server) || string.IsNullOrEmpty(Username) || string.IsNullOrEmpty(Password))
        {
            Snackbar.Add("Please fill in server, username and password first", Severity.Warning);
            return;
        }

        testing = true;
        StateHasChanged();

        try
        {
            var useSsl = UseSsl ?? true;

            if (Provider?.ToLower() == "imap")
            {
                using var client = new ImapClient();
                client.ServerCertificateValidationCallback = (s, c, h, e) => true;
                var port = Port ?? (useSsl ? 993 : 143);

                await client.ConnectAsync(Server, port, useSsl);
                await client.AuthenticateAsync(Username, Password);

                var inbox = client.Inbox;
                await inbox.OpenAsync(FolderAccess.ReadOnly);
                var count = inbox.Count;

                await client.DisconnectAsync(true);

                Snackbar.Add($"IMAP connection successful! Inbox contains {count} message(s).", Severity.Success);
            }
            else if (Provider?.ToLower() == "pop3")
            {
                using var client = new Pop3Client();
                client.ServerCertificateValidationCallback = (s, c, h, e) => true;
                var port = Port ?? (useSsl ? 995 : 110);

                await client.ConnectAsync(Server, port, useSsl);
                await client.AuthenticateAsync(Username, Password);

                var count = await client.GetMessageCountAsync();

                await client.DisconnectAsync(true);

                Snackbar.Add($"POP3 connection successful! Mailbox contains {count} message(s).", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Unknown provider: {Provider}", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Connection failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            testing = false;
            StateHasChanged();
        }
    }
}
