@page "/clients/add"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IDbContextFactory<DefaultdbContext> DbFactory
@inject NavigationManager NavigationManager
@using Microsoft.EntityFrameworkCore

<PageTitle>Add New Client</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">Add New Client</MudText>

<MudPaper Class="pa-4">
    <MudForm @ref="form" @bind-IsValid="@success">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudTextField Label="First Name"
                              @bind-Value="newCustomer.Firstname"
                              Required="true"
                              RequiredError="First name is required" />
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudTextField Label="Last Name"
                              @bind-Value="newCustomer.Lastname"
                              Required="true"
                              RequiredError="Last name is required" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField Label="Company Name"
                              @bind-Value="newCustomer.Companyname"
                              HelperText="Optional" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField Label="Street"
                              @bind-Value="newCustomer.Street"
                              Required="true"
                              RequiredError="Street is required" />
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudTextField Label="ZIP Code"
                              @bind-Value="newCustomer.Zip"
                              Required="true"
                              RequiredError="ZIP code is required" />
            </MudItem>

            <MudItem xs="12" sm="8">
                <MudTextField Label="City"
                              @bind-Value="newCustomer.City"
                              Required="true"
                              RequiredError="City is required" />
            </MudItem>

            <MudItem xs="12">
                <CountrySelect @bind-Value="newCustomer.Country" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField Label="Email Address"
                              @bind-Value="newCustomer.Emailaddress"
                              Required="true"
                              RequiredError="Email is required"
                              InputType="InputType.Email" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField Label="Username"
                              @bind-Value="newCustomer.Username"
                              HelperText="Optional - for customer portal access" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField Label="Companyinformation"
                              @bind-Value="newCustomer.Companyinformation"
                              Lines="5"
                              Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12">
                <MudSelect Label="Package"
                           @bind-Value="newCustomer.PackageId"
                           T="int?"
                           Clearable="true"
                           ToStringFunc="@(id => GetPackageDisplay(id))"
                           HelperText="Select a package or leave empty for no package">
                    @foreach (var package in packages)
                    {
                        <MudSelectItem Value="@((int?)package.Id)">
                            @package.Description (@package.Maxconvsations conversations/month - @package.Price.ToString("C"))
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" Class="d-flex justify-space-between">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Default"
                           OnClick="Cancel">
                    Cancel
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="Save"
                           Disabled="@(!success)">
                    Create Client
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudForm>
</MudPaper>

@code {
    private Customer newCustomer = new();
    private MudForm? form;
    private bool success;
    private List<Package> packages = new();

    protected override async Task OnInitializedAsync()
    {
        // Load packages from database
        await using var db = await DbFactory.CreateDbContextAsync();
        packages = await db.Packages.AsNoTracking().ToListAsync();

        // Initialize new customer with default values
        newCustomer = new Customer
        {
            Firstname = "",
            Lastname = "",
            Companyname = "",
            Street = "",
            Zip = "",
            City = "",
            Country = "",
            Emailaddress = "",
            State = "active",
            Username = "",
            PackageId = null
        };
    }

    private string GetPackageDisplay(int? packageId)
    {
        if (!packageId.HasValue)
            return "No package";

        var package = packages.FirstOrDefault(p => p.Id == packageId.Value);
        if (package == null)
            return packageId.Value.ToString();

        return $"{package.Description} ({package.Maxconvsations} conversations/month - {package.Price:C})";
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/clients/manage");
    }

    private async Task Save()
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        // Add new customer to database
        db.Customers.Add(newCustomer);
        await db.SaveChangesAsync();

        // Navigate back to manage clients page
        NavigationManager.NavigateTo("/clients/manage");
    }
}
