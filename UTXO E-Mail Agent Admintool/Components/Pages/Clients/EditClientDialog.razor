@inject IDbContextFactory<DefaultdbContext> DbFactory
@inject PasswordService PasswordService
@inject EmailService EmailService
@inject ISnackbar Snackbar
@using UTXO_E_Mail_Agent_Admintool.Services

<MudDialog>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@success">
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudTextField Label="First Name"
                                  @bind-Value="editCustomer.Firstname"
                                  Required="true"
                                  RequiredError="First name is required" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField Label="Last Name"
                                  @bind-Value="editCustomer.Lastname"
                                  Required="true"
                                  RequiredError="Last name is required" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField Label="Company Name"
                                  @bind-Value="editCustomer.Companyname" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField Label="Street"
                                  @bind-Value="editCustomer.Street"
                                  Required="true" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField Label="ZIP Code"
                                  @bind-Value="editCustomer.Zip"
                                  Required="true" />
                </MudItem>
                <MudItem xs="12" sm="8">
                    <MudTextField Label="City"
                                  @bind-Value="editCustomer.City"
                                  Required="true" />
                </MudItem>
                <MudItem xs="12">
                    <CountrySelect @bind-Value="editCustomer.Country" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField Label="Email Address"
                                  @bind-Value="editCustomer.Emailaddress"
                                  Required="true"
                                  RequiredError="Email is required"
                                  InputType="InputType.Email" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField Label="Companyinformation"
                                  @bind-Value="editCustomer.Companyinformation"
                                  Lines="5"
                                  Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField Label="Username"
                                  @bind-Value="editCustomer.Username"
                                  HelperText="Optional - for customer portal access" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField Label="Password"
                                  Value="@GetPasswordDisplay()"
                                  ReadOnly="true"
                                  InputType="InputType.Password"
                                  HelperText="Password is hashed and cannot be displayed" />
                </MudItem>

                <MudItem xs="12">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Warning"
                               StartIcon="@Icons.Material.Filled.Key"
                               OnClick="GenerateAndSendPassword"
                               Disabled="sendingPassword">
                        @if (sendingPassword)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Sending...</span>
                        }
                        else
                        {
                            <span>Generate & Send New Password</span>
                        }
                    </MudButton>
                </MudItem>

                <MudItem xs="12">
                    <MudSelect Label="Package"
                               @bind-Value="editCustomer.PackageId"
                               T="int?"
                               Clearable="true"
                               ToStringFunc="@(id => GetPackageDisplay(id))"
                               HelperText="Select a package or leave empty for no package">
                        @foreach (var package in packages)
                        {
                            <MudSelectItem Value="@((int?)package.Id)">
                                @package.Description (@package.Maxconvsations conversations/month - @package.Price.ToString("C"))
                            </MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Save" Disabled="@(!success)">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public Customer Customer { get; set; } = default!;

    private Customer editCustomer = new();
    private MudForm? form;
    private bool success;
    private bool sendingPassword = false;
    private List<Package> packages = new();

    protected override async Task OnInitializedAsync()
    {
        // Load packages from database
        await using var db = await DbFactory.CreateDbContextAsync();
        packages = await db.Packages.AsNoTracking().ToListAsync();

        // Create a copy to avoid modifying the original until save
        editCustomer = new Customer
        {
            Id = Customer.Id,
            Firstname = Customer.Firstname,
            Lastname = Customer.Lastname,
            Companyname = Customer.Companyname,
            Street = Customer.Street,
            Zip = Customer.Zip,
            City = Customer.City,
            Country = Customer.Country,
            Emailaddress = Customer.Emailaddress,
            Companyinformation = Customer.Companyinformation,
            State = Customer.State,
            Username = Customer.Username,
            Passwordhash = Customer.Passwordhash,
            PackageId = Customer.PackageId
        };
    }

    private string GetPasswordDisplay()
    {
        return !string.IsNullOrEmpty(editCustomer.Passwordhash) ? "••••••••••" : "";
    }

    private string GetPackageDisplay(int? packageId)
    {
        if (!packageId.HasValue)
            return "No package";

        var package = packages.FirstOrDefault(p => p.Id == packageId.Value);
        if (package == null)
            return packageId.Value.ToString();

        return $"{package.Description} ({package.Maxconvsations} conversations/month - {package.Price:C})";
    }

    private async Task GenerateAndSendPassword()
    {
        if (string.IsNullOrEmpty(editCustomer.Username))
        {
            Snackbar.Add("Please set a username first before generating a password", Severity.Warning);
            return;
        }

        sendingPassword = true;
        try
        {
            // Generate new password
            var newPassword = PasswordService.GeneratePassword();

            // Hash the password
            var passwordHash = PasswordService.HashPassword(newPassword);

            // Update in database first
            await using var db = await DbFactory.CreateDbContextAsync();
            var customer = await db.Customers.FindAsync(Customer.Id);
            if (customer != null)
            {
                customer.Passwordhash = passwordHash;
                await db.SaveChangesAsync();

                // Update local copy
                editCustomer.Passwordhash = passwordHash;

                // Send email
                await EmailService.SendPasswordResetEmail(
                    editCustomer.Emailaddress,
                    $"{editCustomer.Firstname} {editCustomer.Lastname}",
                    editCustomer.Username,
                    newPassword
                );

                Snackbar.Add($"New password sent to {editCustomer.Emailaddress}", Severity.Success);
            }
        }
        

        catch (Exception ex)
        {
            Snackbar.Add($"Error sending password: {ex.Message}", Severity.Error);
            Console.WriteLine($"[EditClientDialog] Error: {ex}");
        }
        finally
        {
            sendingPassword = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task Save()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        var customer = await db.Customers.FindAsync(Customer.Id);

        if (customer != null)
        {
            customer.Firstname = editCustomer.Firstname;
            customer.Lastname = editCustomer.Lastname;
            customer.Companyname = editCustomer.Companyname;
            customer.Street = editCustomer.Street;
            customer.Zip = editCustomer.Zip;
            customer.City = editCustomer.City;
            customer.Country = editCustomer.Country;
            customer.Emailaddress = editCustomer.Emailaddress;
            customer.Companyinformation = editCustomer.Companyinformation;
            customer.Username = editCustomer.Username;
            customer.PackageId = editCustomer.PackageId;
            // Note: Passwordhash is only updated via GenerateAndSendPassword button

            await db.SaveChangesAsync();
            MudDialog.Close(DialogResult.Ok(true));
        }
    }
}
